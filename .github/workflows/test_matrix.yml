name: Test matrix filtering
run-name: Test matrix filtering
on:
  workflow_dispatch:
    inputs:
      workers:
        description: Service names (comma separated)
        type: string
        required: true

jobs:
  split:
    runs-on: ubuntu-latest
    outputs:
      workers: ${{ steps.set-matrix.outputs.workers }}
    steps:
        - name: Split input into array
          id: set-matrix
          run: echo "workers=$(echo '${{ github.event.inputs.workers }}' | tr ',' '\n' | jq -R . | jq -sc .)" >> $GITHUB_OUTPUT
  filter:
    runs-on: ubuntu-latest
    needs:
      - split
    strategy:
      matrix:
        value:
          - worker: "background-cron-worker"
            cluster: "general-workers"
          - worker: "background-task-dispatcher-worker"
            cluster: "fargate-only"
          - worker: "general-background-worker"
            cluster: "fargate-only"
          - worker: "gift-registries-background-worker"
            cluster: "fargate-only"
          - worker: "growave-webhooks-delay-worker"
            cluster: "fargate-only"
    steps:
      - name: Print matrix
        if: contains(needs.split.outputs.workers, matrix.value.worker)
        id: print
        run: | 
          echo "Worker: ${{ matrix.value.worker }}, Cluster: ${{ matrix.value.cluster }}"
